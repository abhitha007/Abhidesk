<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AbhiDesk — Realtime Drawing + Screen Share</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f1724;--accent:#06b6d4;--muted:#9aa7b2;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,#071124,#081728);color:#e6eef6}
    .app{max-width:1100px;margin:24px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    header{display:flex;justify-content:space-between;align-items:center}
    .user-pill{background:var(--glass);padding:8px 12px;border-radius:999px;color:var(--accent);font-weight:600}
    .controls{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
    input[type=text]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;min-width:220px}
    button{background:var(--accent);color:#042027;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .canvas-wrap{display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:16px}
    #canvas{border-radius:8px;background:#fff;touch-action:none;display:block;max-width:100%}
    .card{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
    .status{font-size:13px;color:var(--muted)}
    video{width:100%;border-radius:8px;background:#000}
    @media(max-width:980px){.canvas-wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>AbhiDesk — Realtime Drawing + Screen Share</h1>
        <div class="status">Collaborative whiteboard with optional screen sharing</div>
      </div>
      <div>Your User ID: <span id="userId" class="user-pill">...</span></div>
    </header>

    <div class="controls">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="partnerId" type="text" placeholder="Partner User ID (paste here)">
        <button id="joinBtn">Connect</button>
        <button id="createBtn" class="ghost">New ID</button>
      </div>
      <div style="margin-left:auto"><div id="connStatus" class="status">Not connected</div></div>
    </div>

    <div class="canvas-wrap">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <label>Color</label>
            <input id="color" type="color" value="#000000" style="margin-left:8px">
            <label style="margin-left:8px">Width</label>
            <input id="width" type="range" min="1" max="20" value="2" style="width:120px;margin-left:8px">
            <button id="eraseBtn" class="ghost">Eraser</button>
          </div>
          <div>
            <button id="undoBtn" class="ghost">Undo</button>
            <button id="clearBtn" class="ghost">Clear</button>
            <button id="exportBtn">Export PNG</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <canvas id="canvas" width="1000" height="600"></canvas>
        </div>
      </div>

      <aside>
        <div class="card" style="margin-bottom:10px">
          <strong>Session</strong>
          <div style="margin-top:8px"><button id="listenSelf" class="ghost">Listen to my session</button></div>
        </div>

        <div class="card" style="margin-bottom:10px">
          <strong>Screen Share</strong>
          <div style="margin-top:8px">
            <button id="startShare">Start Screen Share</button>
            <button id="stopShare" class="ghost" disabled>Stop Share</button>
          </div>
          <div style="margin-top:8px"><label class="status">Remote Screen:</label><video id="remoteVideo" autoplay playsinline></video></div>
        </div>

        <div class="card">
          <strong>Info & Debug</strong>
          <div style="margin-top:8px" class="status">
            <div id="debugLog">Open console (F12) for detailed logs.</div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  // ------------------ CONFIG ------------------
  const firebaseConfig = {
    apiKey: "AIzaSyDVPnpv5SIIT9gmYdiuDDFGbIt37PWx4vc",
    authDomain: "abhidesk-d26d0.firebaseapp.com",
    projectId: "abhidesk-d26d0",
    storageBucket: "abhidesk-d26d0.appspot.com",
    messagingSenderId: "924205685340",
    appId: "1:924205685340:web:b33b4dfa2be1da2696a499",
    measurementId: "G-ML9D0LTM0D"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ------------------ UI & STATE ------------------
  const userIdEl = document.getElementById('userId');
  let userId = localStorage.getItem('abhi_userid') || generateId();
  function generateId(){ return Math.random().toString(36).substring(2,9); }
  localStorage.setItem('abhi_userid', userId);
  userIdEl.innerText = userId;

  const partnerInput = document.getElementById('partnerId');
  const joinBtn = document.getElementById('joinBtn');
  const createBtn = document.getElementById('createBtn');
  const connStatus = document.getElementById('connStatus');
  const listenSelfBtn = document.getElementById('listenSelf');

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const colorInput = document.getElementById('color');
  const widthInput = document.getElementById('width');
  const eraseBtn = document.getElementById('eraseBtn');
  const undoBtn = document.getElementById('undoBtn');
  const clearBtn = document.getElementById('clearBtn');
  const exportBtn = document.getElementById('exportBtn');

  const startShareBtn = document.getElementById('startShare');
  const stopShareBtn = document.getElementById('stopShare');
  const remoteVideo = document.getElementById('remoteVideo');

  // ------------------ CORE STATE ------------------
  let remoteStrokesMap = {};      // sessionId => strokes[]
  let localStrokes = [];          // strokes created locally (not strictly required)
  let currentStroke = null;
  let drawing = false, lastX=0, lastY=0;

  // default: draw into your own session
  let currentPartner = null;
  let currentConnectedSession = userId;

  ctx.lineCap = 'round'; ctx.lineJoin = 'round';

  // ------------------ CANVAS FIT ------------------
  function fitCanvas(){
    const parentWidth = Math.min(1000, Math.max(320, window.innerWidth - 260));
    const aspect = 1000/600;
    canvas.width = parentWidth;
    canvas.height = Math.round(parentWidth / aspect);
  }
  window.addEventListener('resize', ()=>{ fitCanvas(); });
  fitCanvas();

  // ------------------ FIRESTORE HELPERS ------------------
  function docRefForSession(id){ return db.collection('sessions').doc(id); }
  async function ensureSessionDoc(id){
    try{
      const ref = docRefForSession(id);
      const snap = await ref.get();
      if(!snap.exists) await ref.set({strokes: []});
      console.log('Session doc ensured for', id);
      return ref;
    }catch(err){
      console.error('ensureSessionDoc error', err);
      connStatus.innerText = 'Firestore error: check console & Firebase settings';
      throw err;
    }
  }

  // Start listening with error handling
  let listeners = {};
  function startListen(sessionId){
    if(listeners[sessionId]) return;
    const ref = docRefForSession(sessionId);
    // use onSnapshot with error callback
    const unsub = ref.onSnapshot(docSnap => {
      if(!docSnap.exists) {
        remoteStrokesMap[sessionId] = [];
        return;
      }
      try{
        const data = docSnap.data() || {};
        remoteStrokesMap[sessionId] = data.strokes || [];
      }catch(e){
        console.error('snapshot parse error', e);
      }
    }, err => {
      // handle listen errors (400 etc)
      console.error('onSnapshot error for', sessionId, err);
      connStatus.innerText = `Firestore listen failed (check rules / domain)`;
      // unsubscribe to avoid tight retry loops
      try{ listeners[sessionId] && listeners[sessionId](); }catch(e){}
      delete listeners[sessionId];
    });
    listeners[sessionId] = unsub;
    console.log('listening to', sessionId);
  }

  function stopAllListeners(){ Object.values(listeners).forEach(u=>u()); listeners={}; }

  // ------------------ DRAWING HELPERS ------------------
  function toNormalized(x,y){
    const nx = Math.round((x / canvas.width) * 1000);
    const ny = Math.round((y / canvas.height) * 600);
    return {x:nx,y:ny};
  }

  function beginStroke(x,y){
    currentStroke = { color: colorInput.value, width: parseInt(widthInput.value,10), points: [{x,y}] };
    localStrokes.push(currentStroke);
  }
  function pushPoint(x,y){
    if(!currentStroke) return;
    currentStroke.points.push({x,y});
  }
  async function endStroke(sessionId){
    if(!currentStroke) return;
    const payload = {...currentStroke};
    try{
      await docRefForSession(sessionId).update({strokes: firebase.firestore.FieldValue.arrayUnion(payload)});
    }catch(err){
      // if doc not exist or permission issue -> try set (first time)
      try{ await docRefForSession(sessionId).set({strokes:[payload]}); }
      catch(e){ console.error('write fallback failed', e); connStatus.innerText = 'Firestore write failed'; }
    }
    currentStroke = null;
  }

  function drawStroke(st){
    if(!st || !st.points || st.points.length===0) return;
    ctx.save();
    ctx.lineWidth = st.width || 2;
    ctx.strokeStyle = st.color || '#000';
    ctx.beginPath();
    ctx.moveTo(st.points[0].x * (canvas.width / 1000), st.points[0].y * (canvas.height / 600));
    for(let i=1;i<st.points.length;i++){
      const p = st.points[i];
      ctx.lineTo(p.x * (canvas.width / 1000), p.y * (canvas.height / 600));
    }
    ctx.stroke();
    ctx.restore();
  }

  // ------------------ POINTER EVENTS ------------------
  function pointerDown(e){
    e.preventDefault();
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    const n = toNormalized(x,y);
    beginStroke(n.x,n.y);
    lastX = x; lastY = y;
  }
  function pointerMove(e){
    if(!drawing) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    const n = toNormalized(x,y);
    pushPoint(n.x,n.y);
    // incremental local draw (screen coords)
    ctx.save();
    ctx.lineWidth = parseInt(widthInput.value,10);
    ctx.strokeStyle = colorInput.value;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x,y);
    ctx.stroke();
    ctx.restore();
    lastX = x; lastY = y;
  }
  async function pointerUp(e){
    if(!drawing) return;
    drawing = false;
    await endStroke(currentConnectedSession || userId);
  }

  canvas.addEventListener('mousedown', pointerDown);
  canvas.addEventListener('mousemove', pointerMove);
  canvas.addEventListener('mouseup', pointerUp);
  canvas.addEventListener('mouseleave', pointerUp);
  canvas.addEventListener('touchstart', pointerDown, {passive:false});
  canvas.addEventListener('touchmove', pointerMove, {passive:false});
  canvas.addEventListener('touchend', pointerUp);

  // ------------------ TOOLS ------------------
  eraseBtn.addEventListener('click', ()=>{ colorInput.value = '#ffffff'; });
  undoBtn.addEventListener('click', ()=>{ localStrokes.pop(); }); // local undo only
  clearBtn.addEventListener('click', async ()=>{
    try{
      const ref = docRefForSession(currentConnectedSession || userId);
      await ref.set({strokes: []});
      remoteStrokesMap = {};
    }catch(e){ console.error('clear error', e); connStatus.innerText='Clear failed';}
  });
  exportBtn.addEventListener('click', ()=>{ const url=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`board_${Date.now()}.png`; a.click(); });

  // ------------------ SESSION CONNECT ------------------
  joinBtn.addEventListener('click', async ()=>{
    const pid = partnerInput.value.trim();
    if(!pid){ alert('Enter partner ID'); return; }
    if(pid === userId){ alert('Enter a different ID'); return; }
    currentPartner = pid;
    try{
      await ensureSessionDoc(userId);
      await ensureSessionDoc(currentPartner);
    }catch(e){
      console.error('ensure session error',e);
      alert('Firestore setup problem. Check console & Firebase settings.');
      return;
    }
    startListen(userId);
    startListen(currentPartner);
    currentConnectedSession = userId;
    connStatus.innerText = `Connected with ${currentPartner}`;
  });

  createBtn.addEventListener('click', ()=>{
    userId = generateId();
    localStorage.setItem('abhi_userid', userId);
    userIdEl.innerText = userId;
    currentConnectedSession = userId;
    connStatus.innerText = 'New ID created';
  });

  listenSelfBtn.addEventListener('click', async ()=>{
    try{
      await ensureSessionDoc(userId);
      startListen(userId);
      connStatus.innerText = `Listening to ${userId}`;
    }catch(e){
      console.error(e);
      connStatus.innerText = 'Listen failed';
    }
  });

  // ------------------ WEBRTC SCREEN SHARE (unchanged) ------------------
  let pc=null, localStream=null, callDocRef=null;
  startShareBtn.addEventListener('click', async ()=>{
    if(!currentPartner){ alert('Connect to partner first'); return; }
    startShareBtn.disabled=true; stopShareBtn.disabled=false;
    try{ localStream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:false}); }
    catch(e){ alert('Screen share denied or not supported'); startShareBtn.disabled=false; stopShareBtn.disabled=true; return; }
    pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
    const remoteStream = new MediaStream();
    pc.ontrack = (evt)=>{ evt.streams[0].getTracks().forEach(tr=>remoteStream.addTrack(tr)); remoteVideo.srcObject = remoteStream; };
    const callId = `${userId}_${currentPartner}`;
    callDocRef = db.collection('calls').doc(callId);
    const offerCandidates = callDocRef.collection('offerCandidates');
    const answerCandidates = callDocRef.collection('answerCandidates');
    pc.onicecandidate = e=>{ if(e.candidate) offerCandidates.add(e.candidate.toJSON()); };
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
    await callDocRef.set({offer:{type:offer.type,sdp:offer.sdp}, caller:userId, callee:currentPartner});
    callDocRef.onSnapshot(async snap=>{ const data = snap.data(); if(data && data.answer && !pc.currentRemoteDescription){ await pc.setRemoteDescription(new RTCSessionDescription(data.answer)); }});
    answerCandidates.onSnapshot(snap=>{ snap.docChanges().forEach(async ch=>{ if(ch.type==='added'){ try{ await pc.addIceCandidate(new RTCIceCandidate(ch.doc.data())); }catch(e){console.error(e);} }})});
    localStream.getVideoTracks()[0].onended = ()=>{ stopScreenShare(); };
    connStatus.innerText='Screen share started (offer created)';
  });
  (function watchIncomingCalls(){
    const callsCol = db.collection('calls');
    callsCol.where('callee','==', userId).onSnapshot(snapshot=>{
      snapshot.docChanges().forEach(async change=>{
        if(change.type === 'added'){
          const data = change.doc.data(); if(!data) return;
          const remoteCallRef = db.collection('calls').doc(change.doc.id);
          const offer = data.offer;
          const pc2 = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
          const inboundStream = new MediaStream();
          pc2.ontrack = (evt)=>{ evt.streams[0].getTracks().forEach(t=>inboundStream.addTrack(t)); remoteVideo.srcObject = inboundStream; };
          const answerCandidates = remoteCallRef.collection('answerCandidates');
          const offerCandidates = remoteCallRef.collection('offerCandidates');
          pc2.onicecandidate = e=>{ if(e.candidate) answerCandidates.add(e.candidate.toJSON()); };
          await pc2.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await pc2.createAnswer(); await pc2.setLocalDescription(answer);
          await remoteCallRef.update({answer:{type:answer.type,sdp:answer.sdp}});
          offerCandidates.onSnapshot(snap2=>{ snap2.docChanges().forEach(async ch=>{ if(ch.type==='added'){ try{ await pc2.addIceCandidate(new RTCIceCandidate(ch.doc.data())); }catch(e){console.error(e);} } }); });
          connStatus.innerText = `Answered incoming screen-share from ${data.caller}`;
        }
      });
    });
  })();
  function stopScreenShare(){ if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; } if(pc){ pc.close(); pc=null; } startShareBtn.disabled=false; stopShareBtn.disabled=true; connStatus.innerText='Screen share stopped.'; }
  stopShareBtn.addEventListener('click', stopScreenShare);

  // ------------------ RENDER LOOP ------------------
  (function renderLoop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    Object.keys(remoteStrokesMap).forEach(sid=>{
      const list = remoteStrokesMap[sid]||[];
      list.forEach(st=>drawStroke(st));
    });
    if(currentStroke) drawStroke(currentStroke);
    requestAnimationFrame(renderLoop);
  })();

  // ensure session doc exists at load
  ensureSessionDoc(userId).catch(e=>{ console.error('initial ensure error', e); connStatus.innerText='Firestore init error'; });

  partnerInput.addEventListener('keydown', e=>{ if(e.key==='Enter') joinBtn.click(); });
  </script>
</body>
</html>
