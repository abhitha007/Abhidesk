<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AbhiDesk — Realtime Drawing + Screen Share</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f1724;
  --accent: #06b6d4;
  --accent-hover: #0fbdd9;
  --muted: #9aa7b2;
  --glass: rgba(255,255,255,0.03);
  --toolbar-bg: rgba(0,0,0,0.5);
}

* {box-sizing: border-box; margin:0; padding:0;}
body {
  font-family: 'Inter', Arial, sans-serif;
  background: linear-gradient(180deg,#071124,#081728);
  color: #e6eef6;
  display: flex;
  justify-content: center;
  min-height: 100vh;
}

.app {
  max-width: 1200px;
  width: 100%;
  margin: 24px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow: 0 8px 30px rgba(2,6,23,0.6);
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 16px;
  padding: 18px;
}

header {
  grid-column: 1/-1;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.user-pill {
  background: var(--glass);
  padding: 6px 12px;
  border-radius: 999px;
  color: var(--accent);
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}
.user-pill:hover {background: var(--accent-hover); color:#fff;}

.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.controls input[type=text] {
  padding: 8px;
  border-radius: 8px;
  border:1px solid rgba(255,255,255,0.06);
  background: transparent;
  color: inherit;
  min-width: 200px;
}

.controls button {
  background: var(--accent);
  color:#042027;
  border:0;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  transition: 0.2s;
}
.controls button:hover {background: var(--accent-hover);}

.controls button.ghost {
  background: transparent;
  border:1px solid rgba(255,255,255,0.06);
  color: var(--muted);
}

.canvas-area {
  position: relative;
  background:#fff;
  border-radius:8px;
  display: flex;
  flex-direction: column;
  height: 600px;
}

#canvas {
  width: 100%;
  height: 100%;
  touch-action: none;
  border-radius: 8px;
  background: #fff;
}

.toolbar {
  position: absolute;
  top:10px;
  left:10px;
  background: var(--toolbar-bg);
  padding:8px;
  border-radius:8px;
  display: flex;
  gap:8px;
  flex-wrap: wrap;
  align-items: center;
}

.toolbar input[type=color],
.toolbar input[type=range] {cursor: pointer;}
.toolbar button {font-size:13px; padding:6px 10px;}

.sidebar {
  display: flex;
  flex-direction: column;
  gap:10px;
}

.card {
  padding:12px;
  border-radius:8px;
  background: rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.02);
  display: flex;
  flex-direction: column;
  gap:8px;
}

.card strong {margin-bottom:4px;}

.status {
  font-size:13px;
  color: var(--muted);
}

video {
  width:100%;
  border-radius:8px;
  background:#000;
}

@media(max-width:980px){
  .app {grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>AbhiDesk — Realtime Drawing + Screen Share</h1>
      <div class="status">Collaborative whiteboard with optional screen sharing</div>
    </div>
    <div>
      Your User ID: <span id="userId" class="user-pill" title="Click to copy ID">...</span>
    </div>
  </header>

  <div class="canvas-area">
    <canvas id="canvas"></canvas>
    <div class="toolbar">
      <input id="color" type="color" value="#000000">
      <label>Width</label><input id="width" type="range" min="1" max="20" value="2">
      <button id="eraseBtn">Eraser</button>
      <button id="undoBtn">Undo</button>
      <button id="redoBtn">Redo</button>
      <button id="clearBtn">Clear</button>
      <button id="exportBtn">Export PNG</button>
    </div>
  </div>

  <aside class="sidebar">
    <div class="card">
      <strong>Connect</strong>
      <input id="partnerId" type="text" placeholder="Partner User ID">
      <div style="display:flex; gap:6px;">
        <button id="joinBtn">Connect</button>
        <button id="createBtn" class="ghost">New ID</button>
      </div>
      <button id="listenSelf" class="ghost">Listen to my session</button>
      <div id="connStatus" class="status">Not connected</div>
    </div>

    <div class="card">
      <strong>Screen Share</strong>
      <div style="display:flex; gap:6px;">
        <button id="startShare">Start</button>
        <button id="stopShare" class="ghost" disabled>Stop</button>
      </div>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div class="card">
      <strong>Debug</strong>
      <div id="debugLog" class="status">Open console for logs.</div>
    </div>
  </aside>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
// ------------------ FIREBASE ------------------
const firebaseConfig = {
  apiKey: "AIzaSyDVPnpv5SIIT9gmYdiuDDFGbIt37PWx4vc",
  authDomain: "abhidesk-d26d0.firebaseapp.com",
  projectId: "abhidesk-d26d0",
  storageBucket: "abhidesk-d26d0.appspot.com",
  messagingSenderId: "924205685340",
  appId: "1:924205685340:web:b33b4dfa2be1da2696a499",
  measurementId: "G-ML9D0LTM0D"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ------------------ STATE ------------------
const userIdEl = document.getElementById('userId');
let userId = localStorage.getItem('abhi_userid') || Math.random().toString(36).substring(2,9);
localStorage.setItem('abhi_userid', userId);
userIdEl.innerText = userId;
userIdEl.addEventListener('click', ()=>{navigator.clipboard.writeText(userId); alert('Copied User ID');});

const partnerInput = document.getElementById('partnerId');
const joinBtn = document.getElementById('joinBtn');
const createBtn = document.getElementById('createBtn');
const connStatus = document.getElementById('connStatus');
const listenSelfBtn = document.getElementById('listenSelf');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const colorInput = document.getElementById('color');
const widthInput = document.getElementById('width');
const eraseBtn = document.getElementById('eraseBtn');
const undoBtn = document.getElementById('undoBtn');
const clearBtn = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');
const startShareBtn = document.getElementById('startShare');
const stopShareBtn = document.getElementById('stopShare');
const remoteVideo = document.getElementById('remoteVideo');

let remoteStrokesMap={}, localStrokes=[], currentStroke=null, drawing=false, lastX=0, lastY=0;
let currentPartner=null, currentConnectedSession=userId;

// ------------------ CANVAS ------------------
function fitCanvas(){
  const parentWidth = Math.min(1000, Math.max(320, window.innerWidth-260));
  const aspect = 1000/600;
  canvas.width = parentWidth;
  canvas.height = Math.round(parentWidth / aspect);
}
window.addEventListener('resize', fitCanvas);
fitCanvas();

// ------------------ FIRESTORE ------------------
function docRefForSession(id){return db.collection('sessions').doc(id);}
async function ensureSessionDoc(id){const ref = docRefForSession(id); const snap=await ref.get(); if(!snap.exists) await ref.set({strokes:[]}); return ref;}

let listeners={};
function startListen(sessionId){
  if(listeners[sessionId]) return;
  const ref = docRefForSession(sessionId);
  listeners[sessionId] = ref.onSnapshot(docSnap=>{
    const data = docSnap.data()||{};
    remoteStrokesMap[sessionId] = data.strokes||[];
  }, err=>{console.error(err); connStatus.innerText='Listen error';});
}

function stopAllListeners(){Object.values(listeners).forEach(u=>u()); listeners={};}

// ------------------ DRAWING ------------------
function toNormalized(x,y){return {x:Math.round((x/canvas.width)*1000),y:Math.round((y/canvas.height)*600)};}
function beginStroke(x,y){currentStroke={color:colorInput.value,width:parseInt(widthInput.value,10),points:[{x,y}]}; localStrokes.push(currentStroke);}
function pushPoint(x,y){if(currentStroke) currentStroke.points.push({x,y});}
async function endStroke(sessionId){
  if(!currentStroke) return;
  const payload={...currentStroke};
  try{ await docRefForSession(sessionId).update({strokes: firebase.firestore.FieldValue.arrayUnion(payload)});}
  catch(e){await docRefForSession(sessionId).set({strokes:[payload]});}
  currentStroke=null;
}

function drawStroke(st){
  if(!st || !st.points || st.points.length===0) return;
  ctx.save();
  ctx.lineWidth = st.width||2;
  ctx.strokeStyle = st.color||'#000';
  ctx.beginPath();
  ctx.moveTo(st.points[0].x*(canvas.width/1000), st.points[0].y*(canvas.height/600));
  for(let i=1;i<st.points.length;i++){
    const p=st.points[i];
    ctx.lineTo(p.x*(canvas.width/1000), p.y*(canvas.height/600));
  }
  ctx.stroke();
  ctx.restore();
}

// ------------------ POINTER ------------------
function pointerDown(e){
  e.preventDefault(); drawing=true;
  const rect = canvas.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
  const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
  const n=toNormalized(x,y);
  beginStroke(n.x,n.y); lastX=x; lastY=y;
}
function pointerMove(e){
  if(!drawing) return;
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
  const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
  const n=toNormalized(x,y);
  pushPoint(n.x,n.y);
  ctx.save();
  ctx.lineWidth=parseInt(widthInput.value,10);
  ctx.strokeStyle=colorInput.value;
  ctx.beginPath();
  ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke();
  ctx.restore();
  lastX=x; lastY=y;
}
async function pointerUp(e){if(!drawing) return; drawing=false; await endStroke(currentConnectedSession||userId);}
canvas.addEventListener('mousedown', pointerDown);
canvas.addEventListener('mousemove', pointerMove);
canvas.addEventListener('mouseup', pointerUp);
canvas.addEventListener('mouseleave', pointerUp);
canvas.addEventListener('touchstart', pointerDown,{passive:false});
canvas.addEventListener('touchmove', pointerMove,{passive:false});
canvas.addEventListener('touchend', pointerUp);

// ------------------ TOOLS ------------------
eraseBtn.addEventListener('click',()=>{colorInput.value='#ffffff';});
undoBtn.addEventListener('click',()=>{localStrokes.pop();});
clearBtn.addEventListener('click', async()=>{
  try{ await docRefForSession(currentConnectedSession||userId).set({strokes:[]}); remoteStrokesMap={}; }catch(e){console.error(e);}
});
exportBtn.addEventListener('click',()=>{const url=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`board_${Date.now()}.png`; a.click();});

// ------------------ SESSION ------------------
joinBtn.addEventListener('click', async()=>{
  const pid = partnerInput.value.trim();
  if(!pid){alert('Enter partner ID'); return;}
  if(pid===userId){alert('Use different ID'); return;}
  currentPartner=pid;
  await ensureSessionDoc(userId); await ensureSessionDoc(currentPartner);
  startListen(userId); startListen(currentPartner);
  currentConnectedSession=userId; connStatus.innerText=`Connected with ${currentPartner}`;
});

createBtn.addEventListener('click', ()=>{
  userId=Math.random().toString(36).substring(2,9);
  localStorage.setItem('abhi_userid',userId);
  userIdEl.innerText=userId;
  currentConnectedSession=userId;
  connStatus.innerText='New ID created';
});

listenSelfBtn.addEventListener('click', async()=>{
  await ensureSessionDoc(userId);
  startListen(userId);
  connStatus.innerText=`Listening to ${userId}`;
});

// ------------------ SCREEN SHARE ------------------
let pc=null, localStream=null, callDocRef=null;
startShareBtn.addEventListener('click', async()=>{
  if(!currentPartner){alert('Connect first'); return;}
  startShareBtn.disabled=true; stopShareBtn.disabled=false;
  try{localStream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:false});}
  catch(e){alert('Screen share denied'); startShareBtn.disabled=false; stopShareBtn.disabled=true; return;}
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  const remoteStream=new MediaStream();
  pc.ontrack=(evt)=>{evt.streams[0].getTracks().forEach(tr=>remoteStream.addTrack(tr)); remoteVideo.srcObject=remoteStream;};
  const callId=`${userId}_${currentPartner}`;
  callDocRef=db.collection('calls').doc(callId);
  const offerCandidates=callDocRef.collection('offerCandidates');
  const answerCandidates=callDocRef.collection('answerCandidates');
  pc.onicecandidate=e=>{if(e.candidate) offerCandidates.add(e.candidate.toJSON());};
  const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
  await callDocRef.set({offer:{type:offer.type,sdp:offer.sdp}, caller:userId, callee:currentPartner});
  callDocRef.onSnapshot(async snap=>{ const data=snap.data(); if(data && data.answer && !pc.currentRemoteDescription) await pc.setRemoteDescription(new RTCSessionDescription(data.answer)); });
  answerCandidates.onSnapshot(snap=>{ snap.docChanges().forEach(async ch=>{ if(ch.type==='added') try{await pc.addIceCandidate(new RTCIceCandidate(ch.doc.data()));}catch(e){console.error(e);}}); });
  localStream.getVideoTracks()[0].onended=()=>{ stopScreenShare(); };
  connStatus.innerText='Screen share started';
});

function stopScreenShare(){ if(localStream){localStream.getTracks().forEach(t=>t.stop()); localStream=null;} if(pc){pc.close(); pc=null;} startShareBtn.disabled=false; stopShareBtn.disabled=true; connStatus.innerText='Screen share stopped'; }
stopShareBtn.addEventListener('click', stopScreenShare);

// ------------------ RENDER ------------------
(function renderLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  Object.keys(remoteStrokesMap).forEach(sid=>{(remoteStrokesMap[sid]||[]).forEach(st=>drawStroke(st));});
  if(currentStroke) drawStroke(currentStroke);
  requestAnimationFrame(renderLoop);
})();
</script>
</body>
</html>
